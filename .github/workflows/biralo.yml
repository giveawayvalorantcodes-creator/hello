name: Pterodactyl Full Node Backup & Restore

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  backup_and_restore:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore previous backup (if exists)
        uses: actions/download-artifact@v4
        with:
          name: pterodactyl-node-full
          path: ./restore
        continue-on-error: true

      - name: Unzip and restore
        if: success() && steps.download-artifact.outcome == 'success'
        run: |
          sudo cp -r ./restore/* /
          echo "Restored previous backup into place."

      - name: Update system packages
        run: |
          sudo apt update && sudo apt upgrade -y

      - name: Install prerequisites
        run: |
          sudo apt install -y zip unzip sudo

      - name: Full Pterodactyl Wings Node Backup
        run: |
          sudo mkdir -p /opt/pterodactyl-backup-full
          sudo cp /etc/pterodactyl/config.yml /opt/pterodactyl-backup-full/ || true
          sudo cp -r /var/lib/pterodactyl /opt/pterodactyl-backup-full/ || true
          sudo cp -r /var/log/pterodactyl /opt/pterodactyl-backup-full/ || true
          sudo cp -r /tmp/pterodactyl /opt/pterodactyl-backup-full/ || true

      - name: Archive configuration
        run: |
          cd /opt
          zip -r pterodactyl-node-full.zip pterodactyl-backup-full

      - name: Upload full backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: pterodactyl-node-full
          path: /opt/pterodactyl-node-full.zip
